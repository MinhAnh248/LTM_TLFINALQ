<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu√©t H√≥a ƒê∆°n - ƒê√£ S·ª≠a L·ªói</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { border: 4px solid #f3f3f3; border-top: 4px solid #4caf50; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-100 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">üßæ Qu√©t H√≥a ƒê∆°n</h1>
        
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Upload Section -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">T·∫£i l√™n h√¨nh ·∫£nh</h2>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500" 
                     onclick="document.getElementById('fileInput').click()">
                    <div class="text-4xl mb-4">üì∑</div>
                    <p class="text-gray-600">Nh·∫•n ƒë·ªÉ ch·ªçn h√¨nh ·∫£nh h√≥a ƒë∆°n</p>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>
                
                <div id="preview" class="mt-4 hidden">
                    <img id="previewImg" class="w-full max-h-64 object-contain rounded mb-4">
                    <button id="processBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                        Ph√¢n t√≠ch h√≥a ƒë∆°n
                    </button>
                </div>
                
                <div id="loading" class="text-center py-8 hidden">
                    <div class="loading mx-auto"></div>
                    <p class="mt-4 text-gray-600">ƒêang x·ª≠ l√Ω...</p>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">K·∫øt qu·∫£</h2>
                <div id="results" class="text-gray-500">
                    Ch∆∞a c√≥ d·ªØ li·ªáu
                </div>
                
                <div id="actions" class="mt-4 space-x-2 hidden">
                    <button id="saveBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        üí∞ L∆∞u chi ti√™u
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        
        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('processBtn').addEventListener('click', processImage);
        document.getElementById('saveBtn').addEventListener('click', saveExpense);
        
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('preview').classList.remove('hidden');
                document.getElementById('results').innerHTML = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
                document.getElementById('actions').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        async function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            
            showLoading(true);
            
            try {
                // OCR v·ªõi Tesseract
                const { data: { text } } = await Tesseract.recognize(file, 'vie+eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            document.querySelector('#loading p').textContent = `ƒêang nh·∫≠n di·ªán... ${progress}%`;
                        }
                    }
                });
                
                console.log('OCR Text:', text);
                
                // Ph√¢n t√≠ch ƒë∆°n gi·∫£n
                const result = parseReceipt(text);
                displayResults(result, text);
                
            } catch (error) {
                console.error('L·ªói OCR:', error);
                document.getElementById('results').innerHTML = 
                    '<div class="text-red-500">‚ùå L·ªói: Kh√¥ng th·ªÉ ƒë·ªçc h√≥a ƒë∆°n. Vui l√≤ng th·ª≠ l·∫°i v·ªõi h√¨nh ·∫£nh r√µ n√©t h∆°n.</div>';
            } finally {
                showLoading(false);
            }
        }
        
        function parseReceipt(text) {
            const lines = text.split('\n').filter(line => line.trim());
            
            // T√¨m t·ªïng ti·ªÅn (c√°c pattern ph·ªï bi·∫øn)
            let total = 0;
            const totalPatterns = [
                /t·ªïng.*?(\d{1,3}(?:[,.]?\d{3})*)/i,
                /total.*?(\d{1,3}(?:[,.]?\d{3})*)/i,
                /th√†nh ti·ªÅn.*?(\d{1,3}(?:[,.]?\d{3})*)/i
            ];
            
            for (const line of lines) {
                for (const pattern of totalPatterns) {
                    const match = line.match(pattern);
                    if (match) {
                        total = parseInt(match[1].replace(/[,.]/, ''));
                        break;
                    }
                }
                if (total > 0) break;
            }
            
            // T√¨m t√™n c·ª≠a h√†ng (th∆∞·ªùng ·ªü ƒë·∫ßu)
            let storeName = '';
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i].trim();
                if (line.length > 3 && !line.match(/^\d/) && !line.includes('h√≥a ƒë∆°n')) {
                    storeName = line;
                    break;
                }
            }
            
            // T√¨m ng√†y
            let date = '';
            const datePattern = /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/;
            for (const line of lines) {
                const match = line.match(datePattern);
                if (match) {
                    date = match[1];
                    break;
                }
            }
            
            return { storeName, date, total };
        }
        
        function displayResults(data, rawText) {
            currentData = data;
            
            const html = `
                <div class="space-y-3">
                    <div><strong>C·ª≠a h√†ng:</strong> ${data.storeName || 'Kh√¥ng x√°c ƒë·ªãnh'}</div>
                    <div><strong>Ng√†y:</strong> ${data.date || 'Kh√¥ng x√°c ƒë·ªãnh'}</div>
                    <div><strong>T·ªïng ti·ªÅn:</strong> ${data.total ? data.total.toLocaleString() + ' VNƒê' : 'Kh√¥ng x√°c ƒë·ªãnh'}</div>
                </div>
                <details class="mt-4">
                    <summary class="cursor-pointer text-blue-500">Xem vƒÉn b·∫£n g·ªëc</summary>
                    <pre class="mt-2 text-xs bg-gray-100 p-2 rounded">${rawText}</pre>
                </details>
            `;
            
            document.getElementById('results').innerHTML = html;
            
            if (data.total > 0) {
                document.getElementById('actions').classList.remove('hidden');
            }
        }
        
        async function saveExpense() {
            if (!currentData || !currentData.total) {
                alert('Kh√¥ng c√≥ th√¥ng tin s·ªë ti·ªÅn ƒë·ªÉ l∆∞u!');
                return;
            }
            
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/giao-dich', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        loai: 'chi',
                        so_tien: currentData.total,
                        mo_ta: `H√≥a ƒë∆°n t·ª´ ${currentData.storeName || 'C·ª≠a h√†ng'} - ${currentData.date || ''}`,
                        ngay: currentData.date || new Date().toISOString().split('T')[0]
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ ƒê√£ l∆∞u chi ti√™u th√†nh c√¥ng!');
                    document.getElementById('saveBtn').disabled = true;
                    document.getElementById('saveBtn').textContent = '‚úÖ ƒê√£ l∆∞u';
                } else {
                    const error = await response.json();
                    alert(`‚ùå L·ªói: ${error.message}`);
                }
            } catch (error) {
                console.error('L·ªói:', error);
                alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi server!');
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
            document.getElementById('preview').classList.toggle('hidden', show);
        }
    </script>
</body>
</html>