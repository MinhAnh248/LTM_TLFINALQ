<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xuáº¥t ThÃ´ng Tin HÃ³a ÄÆ¡n SiÃªu Thá»‹ - OCR</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, getDoc, collection, query, where, getDocs,deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, addDoc, getDoc, collection, query, where, getDocs,deleteDoc, serverTimestamp
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%); }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .card { background-color: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.1); padding: 24px; border: 1px solid #c8e6c9; }
        .gradient-bg { background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); }
        .btn-primary { background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        .btn-secondary { background-color: #f1f8e9; color: #2e7d32; transition: background-color 0.2s ease; }
        .btn-secondary:hover { background-color: #e8f5e8; }
        .upload-area { border: 2px dashed #81c784; transition: border-color 0.2s ease, background-color 0.2s ease; }
        .upload-area:hover { border-color: #4caf50; background-color: #f1f8e9; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4caf50; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button {
            @apply px-4 py-2 text-gray-600 font-semibold rounded-lg transition-colors;
        }
        .tab-button.active {
            @apply bg-green-50 text-green-700;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="container">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">ğŸ§¾ TrÃ­ch Xuáº¥t ThÃ´ng Tin HÃ³a ÄÆ¡n</h1>
            <p class="text-gray-500 text-lg">Sá»­ dá»¥ng cÃ´ng nghá»‡ OCR & AI Ä‘á»ƒ phÃ¢n tÃ­ch dá»¯ liá»‡u hÃ³a Ä‘Æ¡n cá»§a báº¡n.</p>
        </header>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Left Section (Tabs) -->
            <div class="card">
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="inputTab" class="tab-button active">Táº£i lÃªn & PhÃ¢n tÃ­ch</button>
                    <button id="searchTab" class="tab-button">HÃ³a Ä‘Æ¡n Ä‘Ã£ lÆ°u</button>
                </div>
                
                <!-- Input/Upload Section -->
                <div id="inputSection">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Táº£i lÃªn hÃ³a Ä‘Æ¡n</h2>
                    <select id="languageSelect" class="bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm w-full mb-4">
                        <option value="auto">Tá»± Ä‘á»™ng nháº­n diá»‡n</option>
                        <option value="eng">English</option>
                        <option value="vie">Tiáº¿ng Viá»‡t</option>
                    </select>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button id="cameraBtn" class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                            ğŸ“¸ Chá»¥p áº¢nh
                        </button>
                        <button onclick="document.getElementById('fileInput').click()" class="bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                            ğŸ“ Chá»n File
                        </button>
                    </div>
                    
                    <div class="upload-area rounded-lg p-8 text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                        <div class="text-5xl text-gray-400 mb-4">ğŸ“·</div>
                        <p class="text-xl font-medium text-gray-700 mb-2">KÃ©o tháº£ file vÃ o Ä‘Ã¢y</p>
                        <p class="text-gray-400 text-sm">Hoáº·c nháº¥n Ä‘á»ƒ chá»n file</p>
                        <input type="file" id="fileInput" accept="image/*,.pdf" class="hidden" onchange="handleFileUpload(event)">
                    </div>
                    
                    <!-- Camera Modal -->
                    <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 class="text-lg font-semibold mb-4">Chá»¥p áº¢nh HÃ³a ÄÆ¡n</h3>
                                <video id="cameraVideo" class="w-full rounded mb-4" autoplay></video>
                                <canvas id="cameraCanvas" class="hidden"></canvas>
                                <div class="flex gap-2">
                                    <button id="captureBtn" class="flex-1 bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600">
                                        ğŸ“¸ Chá»¥p
                                    </button>
                                    <button id="closeCameraBtn" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">
                                        âŒ ÄÃ³ng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="previewContainer" class="mt-6 hidden">
                        <img id="previewImage" class="w-full max-h-80 object-contain rounded-lg mb-4 shadow-sm" alt="Preview">
                        <button id="processBtn" class="btn-primary text-white font-medium py-3 px-6 rounded-lg w-full">
                            âœ¨ PhÃ¢n TÃ­ch HÃ³a ÄÆ¡n
                        </button>
                    </div>
                </div>

                <!-- Search Section -->
                <div id="searchSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Tra cá»©u hÃ³a Ä‘Æ¡n Ä‘Ã£ lÆ°u</h2>
                    <input type="text" id="searchBox" placeholder="TÃ¬m kiáº¿m theo tÃªn cá»­a hÃ ng hoáº·c ngÃ y..." class="w-full border border-gray-300 rounded-lg p-2 text-gray-700 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="savedBillsContainer" class="max-h-96 overflow-y-auto">
                        <p class="text-center text-gray-400 py-4">Sá»­ dá»¥ng Ã´ tÃ¬m kiáº¿m phÃ­a trÃªn Ä‘á»ƒ tra cá»©u.</p>
                    </div>
                </div>

                <div id="loadingSection" class="text-center py-8 hidden">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="text-gray-500 mt-4">Äang xá»­ lÃ½ hÃ¬nh áº£nh...</p>
                </div>
            </div>

            <!-- Right Section (Results) -->
            <div class="card">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">ThÃ´ng Tin HÃ³a ÄÆ¡n</h2>
                    <div class="flex space-x-2">
                        <button id="copyBtn" class="btn-secondary text-gray-700 font-medium py-2 px-4 rounded-lg text-sm hidden">ğŸ“‹ Sao chÃ©p</button>
                        <button id="exportBtn" class="btn-primary text-white font-medium py-2 px-4 rounded-lg text-sm hidden">ğŸ“Š Xuáº¥t Excel</button>
                        <button id="saveExpenseBtn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg text-sm hidden">ğŸ’° LÆ°u Chi TiÃªu</button>
                        <button id="saveBtn" class="btn-primary text-white font-medium py-2 px-4 rounded-lg text-sm hidden">ğŸ’¾ LÆ°u HÃ³a ÄÆ¡n</button>
                    </div>
                </div>

                <div id="resultsContent" class="space-y-4 text-gray-700">
                    <div class="text-center text-gray-400 py-16">
                        <div class="text-5xl mb-4">ğŸ“‹</div>
                        <p>Táº£i lÃªn hÃ¬nh áº£nh hÃ³a Ä‘Æ¡n Ä‘á»ƒ báº¯t Ä‘áº§u phÃ¢n tÃ­ch</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let currentReceiptInfo = null;
        let currentRawText = null;
        let db;
        let auth;
        let userId;

        document.addEventListener('DOMContentLoaded', async () => {
            // Khá»Ÿi táº¡o Firebase
            const firebaseConfig = {
  apiKey: "AIzaSyDousMef4BCkpjkH2NNsPYYt5pywPneE-U",
  authDomain: "hoadonocr-696fb.firebaseapp.com",
  projectId: "hoadonocr-696fb",
  storageBucket: "hoadonocr-696fb.firebasestorage.app",
  messagingSenderId: "502220052225",
  appId: "1:502220052225:web:e8ea301cfbbb60c93ead00",
  measurementId: "G-B1FFZ64H5N"
};
            const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore } = window.firebase;
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    await signInAnonymously(auth);
                }
            });

            // Gáº¯n sá»± kiá»‡n cho cÃ¡c nÃºt
            document.getElementById('inputTab').addEventListener('click', () => switchTab('input'));
            document.getElementById('searchTab').addEventListener('click', () => switchTab('search'));
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('cameraBtn').addEventListener('click', openCamera);
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);
            document.getElementById('closeCameraBtn').addEventListener('click', closeCamera);

            document.getElementById('processBtn').addEventListener('click', processImage);
            document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('saveExpenseBtn').addEventListener('click', saveToExpense);
            document.getElementById('saveBtn').addEventListener('click', saveReceipt);
            document.getElementById('searchBox').addEventListener('input', loadSavedBills);
            
            // Táº£i hÃ³a Ä‘Æ¡n Ä‘Ã£ lÆ°u ban Ä‘áº§u
            loadSavedBills();
        });

        // HÃ m chuyá»ƒn Ä‘á»•i tab
        function switchTab(tab) {
            const inputSection = document.getElementById('inputSection');
            const searchSection = document.getElementById('searchSection');
            const inputTabBtn = document.getElementById('inputTab');
            const searchTabBtn = document.getElementById('searchTab');
            const resultsContent = document.getElementById('resultsContent');

            if (tab === 'input') {
                inputSection.classList.remove('hidden');
                searchSection.classList.add('hidden');
                inputTabBtn.classList.add('active');
                searchTabBtn.classList.remove('active');
                if (uploadedFile) {
                    displayResults(currentReceiptInfo, currentRawText);
                } else {
                    resultsContent.innerHTML = `<div class="text-center text-gray-400 py-16"><div class="text-5xl mb-4">ğŸ“‹</div><p>Táº£i lÃªn hÃ¬nh áº£nh hÃ³a Ä‘Æ¡n Ä‘á»ƒ báº¯t Ä‘áº§u phÃ¢n tÃ­ch</p></div>`;
                    document.getElementById('copyBtn').classList.add('hidden');
                    document.getElementById('exportBtn').classList.add('hidden');
                    document.getElementById('saveBtn').classList.add('hidden');
                }
            } else {
                inputSection.classList.add('hidden');
                searchSection.classList.remove('hidden');
                inputTabBtn.classList.remove('active');
                searchTabBtn.classList.add('active');
                resultsContent.innerHTML = `<div class="text-center text-gray-400 py-16"><div class="text-5xl mb-4">ğŸ“‹</div><p>Chá»n má»™t hÃ³a Ä‘Æ¡n Ä‘Ã£ lÆ°u Ä‘á»ƒ xem.</p></div>`;
                loadSavedBills();
            }
        }

        let cameraStream = null;
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            setUploadedFile(file);
        }
        
        function setUploadedFile(file) {
            uploadedFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewContainer').classList.remove('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
                clearResults();
            };
            reader.readAsDataURL(file);
        }
        
        async function openCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Camera sau
                });
                document.getElementById('cameraVideo').srcObject = cameraStream;
                document.getElementById('cameraModal').classList.remove('hidden');
            } catch (error) {
                console.error('Lá»—i camera:', error);
                alert('KhÃ´ng thá»ƒ má»Ÿ camera. Vui lÃ²ng kiá»ƒm tra quyá»n truy cáº­p camera.');
            }
        }
        
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
                setUploadedFile(file);
                closeCamera();
            }, 'image/jpeg', 0.8);
        }
        
        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').classList.add('hidden');
        }


        async function processImage() {
            if (!uploadedFile) return;
            const loadingSection = document.getElementById('loadingSection');
            const resultsContent = document.getElementById('resultsContent');
            const previewContainer = document.getElementById('previewContainer');
            const saveBtn = document.getElementById('saveBtn');
            const selectedLanguage = document.getElementById('languageSelect').value;

            loadingSection.classList.remove('hidden');
            previewContainer.classList.add('hidden');

            try {
                let ocrLanguage = selectedLanguage === 'auto' ? 'eng+vie' : selectedLanguage;
                
                const { data: { text } } = await Tesseract.recognize(uploadedFile, ocrLanguage, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            loadingSection.innerHTML = `<div class="loading-spinner mx-auto"></div><p class="text-gray-500 mt-4">Äang nháº­n diá»‡n vÄƒn báº£n... ${progress}%</p>`;
                        }
                    },
                    errorHandler: err => console.error('OCR Error:', err)
                });
                
                if (!text || text.trim().length < 10) {
                    throw new Error('KhÃ´ng Ä‘á»c Ä‘Æ°á»£c vÄƒn báº£n tá»« hÃ¬nh áº£nh');
                }

                currentRawText = text;
                currentReceiptInfo = await parseWithGemini(currentRawText);
                displayResults(currentReceiptInfo, currentRawText);
                
                document.getElementById('copyBtn').classList.remove('hidden');
                document.getElementById('exportBtn').classList.remove('hidden');
                document.getElementById('saveExpenseBtn').classList.remove('hidden');
                saveBtn.classList.remove('hidden');

            } catch (error) {
                console.error('OCR Error:', error);
                resultsContent.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg"><strong>Lá»—i xá»­ lÃ½:</strong> ${error.message || 'KhÃ´ng thá»ƒ Ä‘á»c Ä‘Æ°á»£c hÃ³a Ä‘Æ¡n. Vui lÃ²ng thá»­ vá»›i hÃ¬nh áº£nh rÃµ nÃ©t hÆ¡n.'}</div>`;
            } finally {
                loadingSection.classList.add('hidden');
            }
        }

        // --- HÃ m phÃ¢n tÃ­ch thÃ´ng minh báº±ng Gemini AI ---
        async function parseWithGemini(ocrText) {
            try {
                const prompt = `PhÃ¢n tÃ­ch vÄƒn báº£n hÃ³a Ä‘Æ¡n vÃ  tráº£ vá» JSON vá»›i: storeName, date (YYYY-MM-DD), total (sá»‘), items (array). VÄƒn báº£n: ${ocrText}`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyCOj3-xvtYhVbk4hx53wC1D8umPCnty7Zg`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error('API Error');
                
                const result = await response.json();
                const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(jsonString);
            } catch (error) {
                console.error('Gemini Error:', error);
                return parseReceiptFallback(ocrText);
            }
        }
        
        function parseReceiptFallback(text) {
            const lines = text.split('\n').filter(line => line.trim());
            
            let total = 0;
            const totalPatterns = [/tá»•ng.*?(\d{1,3}(?:[,.]?\d{3})*)/i, /total.*?(\d{1,3}(?:[,.]?\d{3})*)/i];
            for (const line of lines) {
                for (const pattern of totalPatterns) {
                    const match = line.match(pattern);
                    if (match) {
                        total = parseInt(match[1].replace(/[,.]/g, ''));
                        break;
                    }
                }
                if (total > 0) break;
            }
            
            let storeName = lines.find(line => line.length > 3 && !line.match(/^\d/)) || '';
            let date = '';
            const dateMatch = text.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
            if (dateMatch) date = dateMatch[1];
            
            return { storeName, date, total, items: [] };
        }

        function clearResults() {
            document.getElementById('resultsContent').innerHTML = `<div class="text-center text-gray-400 py-16"><div class="text-5xl mb-4">ğŸ“‹</div><p>Táº£i lÃªn hÃ¬nh áº£nh hÃ³a Ä‘Æ¡n Ä‘á»ƒ báº¯t Ä‘áº§u phÃ¢n tÃ­ch</p></div>`;
            document.getElementById('copyBtn').classList.add('hidden');
            document.getElementById('exportBtn').classList.add('hidden');
            document.getElementById('saveExpenseBtn').classList.add('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
        }

        async function saveToExpense() {
            if (!currentReceiptInfo || !currentReceiptInfo.total) {
                alert('KhÃ´ng cÃ³ thÃ´ng tin sá»‘ tiá»n Ä‘á»ƒ lÆ°u!');
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ lÆ°u chi tiÃªu!');
                window.location.href = 'index.html';
                return;
            }

            const transactionData = {
                loai: 'chi',
                so_tien: currentReceiptInfo.total,
                mo_ta: `HÃ³a Ä‘Æ¡n tá»« ${currentReceiptInfo.storeName || 'Cá»­a hÃ ng'} - ${currentReceiptInfo.date || ''}`,
                ngay: currentReceiptInfo.date || new Date().toISOString().split('T')[0]
            };

            console.log('Gá»­i dá»¯ liá»‡u:', transactionData);

            try {
                const response = await fetch('http://localhost:5000/api/giao-dich', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(transactionData)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    alert('âœ… ÄÃ£ lÆ°u vÃ o chi tiÃªu thÃ nh cÃ´ng!');
                } else {
                    const errorText = await response.text();
                    console.error('Lá»—i response:', errorText);
                    try {
                        const error = JSON.parse(errorText);
                        alert(`âŒ Lá»—i: ${error.message || 'KhÃ´ng thá»ƒ lÆ°u chi tiÃªu'}`);
                    } catch {
                        alert(`âŒ Lá»—i: ${errorText}`);
                    }
                }
            } catch (error) {
                console.error('Lá»—i khi lÆ°u chi tiÃªu:', error);
                alert('âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n server! Kiá»ƒm tra backend Ä‘ang cháº¡y trÃªn port 5000');
            }
        }

        function displayResults(receiptInfo, rawText) {
            const resultsContent = document.getElementById('resultsContent');
            const itemsHtml = receiptInfo.items.length > 0 ? 
                receiptInfo.items.map(item => `
                    <tr>
                        <td class="p-3 text-sm text-gray-600 whitespace-nowrap">${item.name}</td>
                        <td class="p-3 text-sm text-gray-600 whitespace-nowrap">${item.quantity}</td>
                        <td class="p-3 text-sm text-gray-600 text-right whitespace-nowrap">${item.price} VNÄ</td>
                    </tr>
                `).join('') : 
                '<tr><td colspan="3" class="p-4 text-center text-gray-400">KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m.</td></tr>';

            resultsContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 rounded-lg bg-gray-50 border border-gray-200"><div class="text-xs font-semibold text-gray-500 uppercase">TÃªn Cá»­a HÃ ng</div><div class="mt-1 text-lg font-medium text-gray-800">${receiptInfo.storeName || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}</div></div>
                    <div class="p-4 rounded-lg bg-gray-50 border border-gray-200"><div class="text-xs font-semibold text-gray-500 uppercase">NgÃ y</div><div class="mt-1 text-lg font-medium text-gray-800">${receiptInfo.date || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}</div></div>
                </div>

                <div class="mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Danh SÃ¡ch Sáº£n Pháº©m</h3>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200 bg-white">
                            <thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">TÃªn Sáº£n Pháº©m</th><th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Sá»‘ LÆ°á»£ng</th><th class="p-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">GiÃ¡</th></tr></thead>
                            <tbody class="divide-y divide-gray-200">${itemsHtml}</tbody>
                        </table>
                    </div>
                </div>

                ${receiptInfo.total ? `<div class="mt-6 flex justify-end"><div class="p-4 rounded-lg bg-indigo-50 gradient-bg text-white shadow-md"><div class="text-sm font-medium uppercase">Tá»•ng Cá»™ng</div><div class="mt-1 text-3xl font-extrabold">${receiptInfo.total} VNÄ</div></div></div>` : ''}
                
                <div class="mt-6"><details class="p-4 rounded-lg bg-gray-50 border border-gray-200"><summary class="cursor-pointer font-medium text-gray-700">Xem VÄƒn Báº£n Gá»‘c</summary><pre class="mt-4 text-xs text-gray-600 whitespace-pre-wrap">${rawText}</pre></details></div>`;
        }

        // --- Firebase Firestore Functions ---
        async function saveReceipt() {
    if (!currentReceiptInfo) {
        alert('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ lÆ°u!');
        return;
    }
    if (!userId) {
        alert('KhÃ´ng thá»ƒ lÆ°u. Vui lÃ²ng Ä‘Äƒng nháº­p.');
        return;
    }

    const docData = {
        storeName: currentReceiptInfo.storeName,
        date: currentReceiptInfo.date,
        total: currentReceiptInfo.total,
        items: currentReceiptInfo.items,
        rawText: currentRawText,
        timestamp: window.firebase.serverTimestamp(),
        userId: userId,
    };

    try {
        const { collection, addDoc } = window.firebase;
        await addDoc(collection(db, "users", userId, "invoices"), docData);
        alert('âœ… ÄÃ£ lÆ°u hÃ³a Ä‘Æ¡n thÃ nh cÃ´ng!');
        document.getElementById('saveBtn').classList.add('hidden');
        loadSavedBills();
    } catch (error) {
        console.error(" Lá»—i khi lÆ°u tÃ i liá»‡u:", error);
        alert(' Lá»—i khi lÆ°u hÃ³a Ä‘Æ¡n.');
    }
}


        async function loadSavedBills() {
    const container = document.getElementById('savedBillsContainer');
    const searchBox = document.getElementById('searchBox');
    const searchTerm = searchBox.value.toLowerCase();

    if (!userId) {
        container.innerHTML = `<p class="text-center text-gray-400 py-4">Äang káº¿t ná»‘i...</p>`;
        return;
    }

    let allBills = [];
    try {
        const { collection, query, getDocs } = window.firebase;
        const q = query(collection(db, "users", userId, "invoices"));  // ğŸ”¹ dÃ¹ng path chuáº©n
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(doc => {
            allBills.push({ id: doc.id, ...doc.data() });
        });
    } catch (error) {
        console.error(" Lá»—i khi táº£i hÃ³a Ä‘Æ¡n:", error);
        container.innerHTML = `<p class="text-center text-red-500 py-4">Lá»—i khi táº£i hÃ³a Ä‘Æ¡n.</p>`;
        return;
    }

    const filteredBills = allBills.filter(bill =>
        (bill.storeName && bill.storeName.toLowerCase().includes(searchTerm)) ||
        (bill.date && bill.date.includes(searchTerm)) ||
        (bill.total && String(bill.total).includes(searchTerm))
    );

    if (filteredBills.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-400 py-4">KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n nÃ o.</p>`;
        return;
    }

    container.innerHTML = filteredBills.map(bill => `
        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg mb-2 flex justify-between items-center">
            <div class="cursor-pointer flex-1" onclick="viewSavedBill('${bill.id}')">
                <div class="font-semibold text-gray-800">${bill.storeName || 'KhÃ´ng tÃªn'}</div>
                <div class="text-sm text-gray-500">NgÃ y: ${bill.date || 'N/A'} - Tá»•ng: ${bill.total || 'N/A'} VNÄ</div>
            </div>
            <button class="text-red-500 hover:text-red-700 font-bold ml-4" onclick="deleteSavedBill('${bill.id}')">ğŸ—‘ï¸</button>
        </div>
    `).join('');
}


        async function viewSavedBill(id) {
    if (!userId) return;
    try {
        const { doc, getDoc } = window.firebase;
        const docRef = doc(db, "users", userId, "invoices", id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const bill = docSnap.data();
            currentReceiptInfo = {
                storeName: bill.storeName,
                date: bill.date,
                total: bill.total,
                items: bill.items || [],
            };
            currentRawText = bill.rawText;
            displayResults(currentReceiptInfo, currentRawText);
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('copyBtn').classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');
            switchTab('input'); // Quay láº¡i tab nháº­p liá»‡u Ä‘á»ƒ xem káº¿t quáº£
        }
    } catch (error) {
        console.error(" Lá»—i khi xem hÃ³a Ä‘Æ¡n:", error);
        alert(' Lá»—i khi táº£i hÃ³a Ä‘Æ¡n Ä‘Ã£ lÆ°u.');
    }
}

async function deleteSavedBill(id) {
    if (!userId) return;
    if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a hÃ³a Ä‘Æ¡n nÃ y khÃ´ng?")) return;

    try {
        const { doc, deleteDoc } = window.firebase;
        const docRef = doc(db, "users", userId, "invoices", id);
        await deleteDoc(docRef);
        alert("âœ… ÄÃ£ xÃ³a hÃ³a Ä‘Æ¡n thÃ nh cÃ´ng!");
        loadSavedBills(); // Refresh danh sÃ¡ch sau khi xÃ³a
    } catch (error) {
        console.error(" Lá»—i khi xÃ³a hÃ³a Ä‘Æ¡n:", error);
        alert(" Lá»—i khi xÃ³a hÃ³a Ä‘Æ¡n.");
    }
}



        function copyToClipboard() {
            const resultsContent = document.getElementById('resultsContent');
            if (!resultsContent.textContent.trim()) { alert('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ sao chÃ©p!'); return; }
            navigator.clipboard.writeText(resultsContent.textContent).then(() => { alert('âœ… ÄÃ£ sao chÃ©p thÃ´ng tin hÃ³a Ä‘Æ¡n vÃ o clipboard!'); }).catch(() => { alert('âŒ KhÃ´ng thá»ƒ sao chÃ©p.'); });
        }

        function exportToExcel() {
            if (!currentReceiptInfo) { alert('KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!'); return; }
            const info = currentReceiptInfo;
            const ws_data = [["TÃªn Cá»­a HÃ ng", info.storeName], ["NgÃ y", info.date], [], ["TÃªn Sáº£n Pháº©m", "Sá»‘ LÆ°á»£ng", "GiÃ¡"], ...info.items.map(item => [item.name, item.quantity, item.price]), [], ["Tá»•ng Cá»™ng", "", info.total]];
            const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "HoaDon");
            XLSX.writeFile(wb, `HoaDon_${info.date || Date.now()}.xlsx`);
        }
    </script>
</body>
</html>
