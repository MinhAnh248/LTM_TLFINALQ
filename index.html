<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n L√Ω Chi Ti√™u</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      padding: 20px;
    }

    .auth-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      padding: 40px;
      max-width: 400px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    input:focus {
      outline: none;
      border-color: #2196f3;
      box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
    }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
    }

    button:hover {
      background: linear-gradient(135deg, #1e88e5 0%, #1976d2 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }

    .toggle-form {
      text-align: center;
      margin-top: 20px;
      color: #666;
    }

    .toggle-form a {
      color: #2196f3;
      cursor: pointer;
      text-decoration: none;
      font-weight: 600;
    }

    .dashboard {
      display: none;
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .dashboard.active {
      display: block;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 20px;
    }

    .header h1 {
      color: #333;
    }

    .logout-btn {
      background: #e74c3c;
      padding: 10px 20px;
      width: auto;
    }

    .logout-btn:hover {
      background: #c0392b;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
      color: #2e7d32;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid #a5d6a7;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
    }

    .stat-card h3 {
      font-size: 14px;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: bold;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    table th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #ddd;
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    table tr:hover {
      background: #f9f9f9;
    }

    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .nav-tabs button {
      background: none;
      border: none;
      padding: 10px 20px;
      color: #666;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .nav-tabs button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      background: white;
    }

    select:focus {
      outline: none;
      border-color: #2196f3;
      box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        flex-wrap: wrap;
      }

      .nav-tabs button {
        font-size: 12px;
        padding: 8px 12px;
      }

      table {
        font-size: 12px;
      }

      table th,
      table td {
        padding: 8px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Auth Forms -->
    <div id="authContainer" class="auth-container">
      <div id="loginForm">
        <h2 style="margin-bottom: 30px; color: #333">ƒêƒÉng Nh·∫≠p</h2>
        <div class="alert" id="loginAlert"></div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="Nh·∫≠p email" />
        </div>
        <div class="form-group">
          <label>M·∫≠t Kh·∫©u</label>
          <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" />
        </div>
        <button onclick="login()">ƒêƒÉng Nh·∫≠p</button>
        <div class="toggle-form">
          Ch∆∞a c√≥ t√†i kho·∫£n? <a onclick="toggleForm()">ƒêƒÉng K√Ω</a>
        </div>
      </div>

      <div id="registerForm" style="display: none">
        <h2 style="margin-bottom: 30px; color: #333">ƒêƒÉng K√Ω</h2>
        <div class="alert" id="registerAlert"></div>
        <div class="form-group">
          <label>H·ªç T√™n</label>
          <input type="text" id="registerName" placeholder="Nh·∫≠p h·ªç t√™n" />
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="registerEmail" placeholder="Nh·∫≠p email" />
        </div>
        <div class="form-group">
          <label>M·∫≠t Kh·∫©u</label>
          <input type="password" id="registerPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" />
        </div>
        <div class="form-group">
          <label>S·ªë D∆∞ Ban ƒê·∫ßu</label>
          <input type="number" id="registerBalance" placeholder="Nh·∫≠p s·ªë d∆∞" value="0" />
        </div>
        <button onclick="register()">ƒêƒÉng K√Ω</button>
        <div class="toggle-form">
          ƒê√£ c√≥ t√†i kho·∫£n? <a onclick="toggleForm()">ƒêƒÉng Nh·∫≠p</a>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
      <div class="header">
        <h1>Qu·∫£n L√Ω Chi Ti√™u</h1>
        <button class="logout-btn" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
      </div>

      <div class="alert" id="dashboardAlert"></div>

      <div class="stats">
        <div class="stat-card">
          <h3>Thu Nh·∫≠p Th√°ng N√†y</h3>
          <div class="value" id="monthlyIncome">0 VNƒê</div>
        </div>
        <div class="stat-card">
          <h3>Chi Ti√™u Th√°ng N√†y</h3>
          <div class="value" id="monthlyExpense">0 VNƒê</div>
        </div>
        <div class="stat-card">
          <h3>S·ªë D∆∞ Hi·ªán T·∫°i</h3>
          <div class="value" id="currentBalance">0 VNƒê</div>
        </div>
      </div>

      <div class="nav-tabs">
        <button class="active" onclick="switchTab('transactions')">
          Giao D·ªãch
        </button>
        <button onclick="switchTab('categories')">Danh M·ª•c</button>
        <button onclick="window.location.href='ocr_hoadon.html'" style="
              background: linear-gradient(135deg, #f8fafa 0%, #f8fafa 100%);
              color: #666;
              border-radius: 5px;
            ">
          Qu√©t H√≥a ƒê∆°n
        </button>
        <button onclick="window.location.href='voice_receipt.html'" style="
              background: linear-gradient(135deg, #f5f6f5 0%, #f8f9f8 100%);
              color: #666;
              border-radius: 5px;
            ">
          Gi·ªçng N√≥i
        </button>
        <button onclick="window.location.href='ai.html'" style="
              background: linear-gradient(135deg, #f5f6f5 0%, #f8f9f8 100%);
              color: #666;
              border-radius: 5px;
            ">
          AI T∆∞ V·∫•n
        </button>
      </div>

      <!-- Tab Content -->
      <div id="transactionsTab" class="tab-content active">
        <div class="section">
          <h2>Th√™m Giao D·ªãch</h2>
          <div class="form-row">
            <div class="form-group">
              <label>S·ªë Ti·ªÅn</label>
              <input type="number" id="transactionAmount" placeholder="Nh·∫≠p s·ªë ti·ªÅn" />
            </div>
            <div class="form-group">
              <label>Danh M·ª•c</label>
              <select id="transactionCategory">
                <option value="">Ch·ªçn danh m·ª•c</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>M√¥ T·∫£</label>
              <input type="text" id="transactionDescription" placeholder="M√¥ t·∫£ giao d·ªãch" />
            </div>
            <div class="form-group">
              <label>Ng√†y</label>
              <input type="date" id="transactionDate" />
            </div>
          </div>
          <button onclick="addTransaction()">Th√™m Giao D·ªãch</button>
        </div>

        <div class="section">
          <h2>L·ªãch S·ª≠ Giao D·ªãch</h2>
          <table>
            <thead>
              <tr>
                <th>Ng√†y</th>
                <th>Danh M·ª•c</th>
                <th>S·ªë Ti·ªÅn</th>
                <th>M√¥ T·∫£</th>
              </tr>
            </thead>
            <tbody id="transactionTableBody">
              <!-- Transactions will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="categoriesTab" class="tab-content" style="display: none;">
        <div class="section">
          <h2>Th√™m Danh M·ª•c</h2>
          <div class="form-row">
            <div class="form-group">
              <label>T√™n Danh M·ª•c</label>
              <input type="text" id="categoryName" placeholder="Nh·∫≠p t√™n danh m·ª•c" />
            </div>
            <div class="form-group">
              <label>Lo·∫°i</label>
              <select id="categoryType">
                <option value="">Ch·ªçn lo·∫°i</option>
                <option value="Thu nh·∫≠p">Thu nh·∫≠p</option>
                <option value="Chi ti√™u">Chi ti√™u</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Icon (t√πy ch·ªçn)</label>
            <input type="text" id="categoryIcon" placeholder="V√≠ d·ª•: üçî, üí∞, üéÆ" />
          </div>
          <button onclick="addCategory()">Th√™m Danh M·ª•c</button>
        </div>

        <div class="section">
          <h2>Danh S√°ch Danh M·ª•c</h2>
          <table>
            <thead>
              <tr>
                <th>Icon</th>
                <th>T√™n</th>
                <th>Lo·∫°i</th>
              </tr>
            </thead>
            <tbody id="categoryTableBody">
              <!-- Categories will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const API_URL = window.CONFIG.API_URL;
    let token = localStorage.getItem("token");

    if (token) {
      showDashboard();
      loadData();
    }

    function toggleForm() {
      document.getElementById("loginForm").style.display =
        document.getElementById("loginForm").style.display === "none"
          ? "block"
          : "none";
      document.getElementById("registerForm").style.display =
        document.getElementById("registerForm").style.display === "none"
          ? "block"
          : "none";
    }

    async function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      console.log('Login API URL:', `${API_URL}/auth/login`);

      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, mat_khau: password }),
        });

        console.log('Login response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.log('Login error:', errorText);
          showAlert("loginAlert", `L·ªói ${response.status}: ${response.statusText}`, "error");
          return;
        }

        const data = await response.json();
        localStorage.setItem("token", data.access_token);
        token = data.access_token;
        showDashboard();
        loadData();
      } catch (error) {
        console.error('Login fetch error:', error);
        showAlert("loginAlert", `L·ªói k·∫øt n·ªëi: ${error.message}`, "error");
      }
    }

    async function register() {
      const name = document.getElementById("registerName").value;
      const email = document.getElementById("registerEmail").value;
      const password = document.getElementById("registerPassword").value;
      const balance =
        parseFloat(document.getElementById("registerBalance").value) || 0;

      console.log('API URL:', API_URL);
      console.log('Full URL:', `${API_URL}/auth/register`);

      try {
        const response = await fetch(`${API_URL}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ho_ten: name,
            email,
            mat_khau: password,
            so_du: balance,
          }),
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);

        if (!response.ok) {
          console.log('Response not ok:', response.statusText);
          const errorText = await response.text();
          console.log('Error response:', errorText);
          showAlert("registerAlert", `L·ªói ${response.status}: ${response.statusText}`, "error");
          return;
        }

        const data = await response.json();
        console.log('Success response:', data);

        showAlert(
          "registerAlert",
          "ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p",
          "success"
        );
        setTimeout(() => toggleForm(), 1500);
      } catch (error) {
        console.error('Fetch error:', error);
        showAlert("registerAlert", `L·ªói k·∫øt n·ªëi: ${error.message}`, "error");
      }
    }

    function logout() {
      localStorage.removeItem("token");
      token = null;
      document.getElementById("authContainer").style.display = "block";
      document.getElementById("dashboard").classList.remove("active");
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("registerForm").style.display = "none";
    }

    function showDashboard() {
      document.getElementById("authContainer").style.display = "none";
      document.getElementById("dashboard").classList.add("active");
    }

    async function loadData() {
      await loadStatistics();
      await loadCategories();
      await loadTransactions();
    }

    async function loadStatistics() {
      try {
        const response = await fetch(`${API_URL}/thong-ke`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById("monthlyIncome").textContent =
            formatCurrency(data.thu_nhap_thang_nay);
          document.getElementById("monthlyExpense").textContent =
            formatCurrency(data.chi_tieu_thang_nay);
          document.getElementById("currentBalance").textContent =
            formatCurrency(data.so_du);
        }
      } catch (error) {
        console.error("L·ªói t·∫£i th·ªëng k√™:", error);
      }
    }

    async function loadCategories() {
      try {
        const response = await fetch(`${API_URL}/danh-muc`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (response.ok) {
          const categories = await response.json();
          const select = document.getElementById("transactionCategory");
          const tbody = document.getElementById("categoryTableBody");

          select.innerHTML = '<option value="">Ch·ªçn danh m·ª•c</option>';

          if (categories.length === 0) {
            select.innerHTML +=
              '<option value="" disabled>‚ö†Ô∏è Ch∆∞a c√≥ danh m·ª•c - V√†o tab "Danh M·ª•c" ƒë·ªÉ t·∫°o</option>';
            tbody.innerHTML =
              '<tr><td colspan="3" style="text-align: center; color: #999;">‚ö†Ô∏è Ch∆∞a c√≥ danh m·ª•c. H√£y t·∫°o danh m·ª•c m·ªõi!</td></tr>';
            return;
          }

          categories.forEach((cat) => {
            select.innerHTML += `<option value="${cat.id}">${cat.icon || "üìå"} ${cat.ten_danh_muc}</option>`;
          });

          tbody.innerHTML = "";
          categories.forEach((cat) => {
            tbody.innerHTML += `<tr>
                            <td>${cat.icon || "üìå"}</td>
                            <td>${cat.ten_danh_muc}</td>
                            <td>${cat.loai_danh_muc}</td>
                        </tr>`;
          });
        }
      } catch (error) {
        console.error("L·ªói t·∫£i danh m·ª•c:", error);
      }
    }

    async function loadTransactions() {
      try {
        const response = await fetch(`${API_URL}/giao-dich`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (response.ok) {
          const transactions = await response.json();
          const tbody = document.getElementById("transactionTableBody");
          tbody.innerHTML = "";

          transactions.forEach((trans) => {
            tbody.innerHTML += `<tr>
                            <td>${new Date(trans.ngay).toLocaleDateString("vi-VN")}</td>
                            <td>-</td>
                            <td>${formatCurrency(trans.so_tien)}</td>
                            <td>${trans.mo_ta}</td>
                        </tr>`;
          });
        }
      } catch (error) {
        console.error("L·ªói t·∫£i giao d·ªãch:", error);
      }
    }

    async function addTransaction() {
      const categoryId = document.getElementById("transactionCategory").value;
      const amount = parseFloat(
        document.getElementById("transactionAmount").value
      );
      const description = document.getElementById("transactionDescription").value;

      if (!categoryId || !amount) {
        showAlert(
          "dashboardAlert",
          "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin",
          "error"
        );
        return;
      }

      try {
        const response = await fetch(`${API_URL}/giao-dich`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            danh_muc_id: parseInt(categoryId),
            so_tien: amount,
            mo_ta: description,
          }),
        });

        if (response.ok) {
          showAlert("dashboardAlert", "Th√™m giao d·ªãch th√†nh c√¥ng", "success");
          document.getElementById("transactionAmount").value = "";
          document.getElementById("transactionDescription").value = "";
          loadData();
        } else {
          const data = await response.json();
          showAlert("dashboardAlert", data.message, "error");
        }
      } catch (error) {
        showAlert("dashboardAlert", "L·ªói k·∫øt n·ªëi", "error");
      }
    }

    async function addCategory() {
      const type = document.getElementById("categoryType").value;
      const name = document.getElementById("categoryName").value;
      const icon = document.getElementById("categoryIcon").value;

      if (!name || !type) {
        showAlert("dashboardAlert", "Vui l√≤ng nh·∫≠p t√™n v√† lo·∫°i danh m·ª•c", "error");
        return;
      }

      try {
        const response = await fetch(`${API_URL}/danh-muc`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            loai_danh_muc: type,
            ten_danh_muc: name,
            icon: icon,
          }),
        });

        if (response.ok) {
          showAlert("dashboardAlert", "Th√™m danh m·ª•c th√†nh c√¥ng", "success");
          document.getElementById("categoryName").value = "";
          document.getElementById("categoryIcon").value = "";
          loadCategories();
        } else {
          const data = await response.json();
          showAlert("dashboardAlert", data.message, "error");
        }
      } catch (error) {
        showAlert("dashboardAlert", "L·ªói k·∫øt n·ªëi", "error");
      }
    }

    function switchTab(tab) {
      document
        .querySelectorAll(".tab-content")
        .forEach((el) => (el.style.display = "none"));
      document
        .querySelectorAll(".nav-tabs button")
        .forEach((el) => el.classList.remove("active"));

      document.getElementById(tab + "Tab").style.display = "block";
      event.target.classList.add("active");
    }

    function showAlert(elementId, message, type) {
      const alert = document.getElementById(elementId);
      alert.textContent = message;
      alert.className = `alert ${type}`;
      setTimeout(() => {
        alert.className = "alert";
      }, 3000);
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat("vi-VN", {
        style: "currency",
        currency: "VND",
      }).format(value);
    }
  </script>
</body>

</html>